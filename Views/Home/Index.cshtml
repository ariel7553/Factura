
@{
    ViewBag.Title = "Index";
}

<style>
    body {
        margin-top: 20px;
        color: #484b51;
    }

    .text-secondary-d1 {
        color: #728299 !important;
    }

    .page-header {
        margin: 0 0 1rem;
        padding-bottom: 1rem;
        padding-top: .5rem;
        border-bottom: 1px dotted #e2e2e2;
        display: -ms-flexbox;
        display: flex;
        -ms-flex-pack: justify;
        justify-content: space-between;
        -ms-flex-align: center;
        align-items: center;
    }

    .page-title {
        padding: 0;
        margin: 0;
        font-size: 1.75rem;
        font-weight: 300;
    }

    .brc-default-l1 {
        border-color: #dce9f0 !important;
    }

    .ml-n1, .mx-n1 {
        margin-left: -.25rem !important;
    }

    .mr-n1, .mx-n1 {
        margin-right: -.25rem !important;
    }

    .mb-4, .my-4 {
        margin-bottom: 1.5rem !important;
    }

    hr {
        margin-top: 1rem;
        margin-bottom: 1rem;
        border: 0;
        border-top: 1px solid rgba(0,0,0,.1);
    }

    .text-grey-m2 {
        color: #888a8d !important;
    }

    .text-success-m2 {
        color: #86bd68 !important;
    }

    .font-bolder, .text-600 {
        font-weight: 600 !important;
    }

    .text-110 {
        font-size: 110% !important;
    }

    .text-blue {
        color: #478fcc !important;
    }

    .pb-25, .py-25 {
        padding-bottom: .75rem !important;
    }

    .pt-25, .py-25 {
        padding-top: .75rem !important;
    }

    .bgc-default-tp1 {
        background-color: #15a362 !important;
    }

    .bgc-default-l4, .bgc-h-default-l4:hover {
        background-color: #f3f8fa !important;
    }

    .page-header .page-tools {
        -ms-flex-item-align: end;
        align-self: flex-end;
    }

    .btn-light {
        color: #757984;
        background-color: #f5f6f9;
        border-color: #dddfe4;
    }

    .w-2 {
        width: 1rem;
    }

    .text-120 {
        font-size: 120% !important;
    }

    .text-primary-m1 {
        color: #4087d4 !important;
    }

    .text-danger-m1 {
        color: #dd4949 !important;
    }

    .text-blue-m2 {
        color: #68a3d5 !important;
    }

    .text-150 {
        font-size: 150% !important;
    }

    .text-60 {
        font-size: 60% !important;
    }

    .text-grey-m1 {
        color: #7b7d81 !important;
    }

    .align-bottom {
        vertical-align: bottom !important;
    }
</style>



<div class="modal" id="Cantidad" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle"> <strong> Ingrese la Cantidad </strong>  </h5>

            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-12 col-md-12">
                        <div class="form-group">
                            <label class="control-label"> Nombre Producto: </label>
                            <input type="text" class="form-control" disabled id="nombreP" value="" />
                        </div>
                        <div class="form-group">
                            <label> Precio: </label>
                            <input type="text" class="form-control" disabled id="Precio" value="" />
                        </div>
                        <div class="form-group">
                            <label> Cantidad: </label>
                            <input class="form-control" id="Cant" min="1"
                                   onkeypress="return event.charCode >= 48"
                                   oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
                                   type="number"
                                   maxlength="4" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="AgregarProducto()" class="btn app-btn-secondary" data-dismiss="modal">Agregar Producto</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="Clientes" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle"> <strong> Clientes </strong>  </h5>

            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table id="tbClientes" width="100%" class="table table-hover">
                        <thead class="bgc-h-default-l4">
                            <tr>

                                <th>ID</th>
                                <th>Cédula</th>
                                <th>Nombre</th>
                                <th>Apellido</th>
                                <th>Teléfono</th>
                                <th>Dirección</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" onclick="CloseModal('Clientes')" class="btn app-btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>


<div class="modal" id="Productos" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header text-center">
                <h5 class="modal-title" id="exampleModalLongTitle"> <strong> Productos </strong>  </h5>

            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table id="tbProductos" width="100%" class="table table-hover">
                        <thead class="bgc-h-default-l4">
                            <tr>

                                <th>ID</th>
                                <th>Producto</th>
                                <th>Stock</th>
                                <th>Precio U.</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" onclick="CloseModal('Productos')" class="btn app-btn-secondary" data-dismiss="modal">Cerrar</button>

            </div>
        </div>
    </div>
</div>

<div class="page-content ">
    <div class="page-header text-blue-d2">
        <h2 class="page-title text-secondary-d1">
            Factura
            <small class="page-info">
                <i class="fa fa-angle-double-right text-40"></i>
                ID: #111-222
            </small>
        </h2>
    </div>

    <div class="px-0">
        <div class="row mt-0">
            <div class="col-12 col-lg-10 offset-lg-1">
                <div class="row">
                    <div class="col-sm-6">
                        <div>
                            <span class="text-sm text-grey-m2 align-middle">Cliente:</span>
                            <span id="NombreCliente" class="text-600 text-110 text-blue align-middle"> Seleccione... </span>
                        </div>
                        <div class="text-grey-m2">

                            <div id="Ced" class="my-1"><i class=" fa-flip-horizontal text-secondary"></i> <b id="Telefono" class="text-600">000 000 0000</b></div>

                            <div id="Direccion" class="my-1">
                                Street, City
                            </div>

                            <div class="my-1"><i class="fa fa-phone fa-flip-horizontal text-secondary"></i> <b id="Telefono" class="text-600">000 000 0000</b></div>
                        </div>

                        <button onclick="OpenModal('Clientes')" class="btn app-btn-secondary"><i class="fas fa-search-plus"></i> Clientes </button>

                    </div>
                    <!-- /.col -->

                    <div class="text-95 col-sm-6 align-self-start d-sm-flex justify-content-end">
                        <hr class="d-sm-none" />
                        <div class="text-grey-m2">
                            <div class="mt-1 mb-2 text-secondary-m1 text-600 text-125">
                                Factura
                            </div>
                            <div class="my-2"><i class="fa fa-circle text-blue-m2 text-xs mr-1"></i> <span class="text-600 text-90">ID:</span> #111-222</div>
                            <div class="my-2"><i class="fa fa-circle text-blue-m2 text-xs mr-1"></i> <span class="text-600 text-90">Fecha:</span> @DateTime.Now.ToLongDateString()</div>

                            <button id="btnProductos" onclick="OpenModal('Productos')" class="btn app-btn-secondary"> Productos <i class="fas fa-cart-plus"></i>  </button>

                        </div>

                    </div>
                    <!-- /.col -->
                </div>

                <div class="mt-4">

                    <hr />
                    <div class="row border-b-2 brc-default-l2"></div>

                    <!-- or use a table instead -->

                    <div class="table-responsive">
                        <table id="TbFactura" class="table table-striped table-borderless border-0 border-b-2 brc-default-l1">
                            <thead class="bg-none bgc-default-tp1">
                                <tr class="text-white">
                                    <th class="opacity-2">#</th>
                                    <th class="opacity-2">ID</th>
                                    <th>Descripción</th>
                                    <th>Cant.</th>
                                    <th>Precio U.</th>
                                    <th>Total</th>
                                    <th width="140">Opciones</th>
                                </tr>
                            </thead>

                            <tbody class="text-95 text-secondary-d3">
                                <tr></tr>
                                <tr>
                                    <td>1</td>
                                    <td>Domain registration</td>
                                    <td>2</td>
                                    <td class="text-95">$10</td>
                                    <td class="text-secondary-d2">$20</td>
                                    <td class="">
                                        <button class="btn"><i class="fas fa-edit"></i></button> <button class="btn"><i class="fas fa-trash-alt"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="row mt-3">

                        <div class="col-4 col-sm-5 text-grey text-90 order-last order-sm-last ">
                            <div class="row my-2">
                                <div class="col-7 text-right">
                                    SubTotal
                                </div>
                                <div class="col-5">
                                    <span id="Subtotal" class="text-120 text-secondary-d1">$ 0.00</span>
                                </div>
                            </div>

                            <div class="row my-2">
                                <div class="col-7 text-right">
                                    IVA (12%)
                                </div>
                                <div class="col-5">
                                    <span id="Iva" class="text-120 text-secondary-d1">$ 0.00</span>
                                </div>
                            </div>

                            <div class="row my-2 ">
                                <div class="col-7 text-right">
                                    Total
                                </div>
                                <div class="col-5">
                                    <span id="Total" class="text-120 text-success-d3 opacity-2">$ 0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr />

                    <div class="text-center">

                        <button id="btnGuardar" onclick="GuardarFactura()" class="btn app-btn-secondary">  Guardar  <i class="fas fa-file-invoice-dollar"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">
    function CloseModal(NombreModal) {
        $("#" + NombreModal).hide();
    }
    function OpenModal(NombreModal) {
        if (NombreModal == 'Clientes') {
            CargarClientes();
        }

        if (NombreModal == 'Productos') {
            CargarProductos();
        }


        $("#" + NombreModal).show();

    }

    var tablaClientes;
    var tablaProductos;
    var tablaFactura;

    var Cli;
    var ProductoSeleccionado = null;
    var productos = [];

    var temp;
    var Cambio = 1;

    function AgregarProducto() {
        var cant = $("#Cant").val();

        if (cant == "") {
            AlertaMensaje("Cantidad del Producto", "Ingrese la cantidad del producto", 'warning');
            return;
        }

        if (parseInt(cant) <= 0) {
            AlertaMensaje("Cantidad del Producto", "La cantidad No puede ser Cero", 'warning');
            return;
        }

        if (ProductoSeleccionado.Cant > ProductoSeleccionado.Stock) {
            AlertaMensaje("Cantidad en Almacen", "Cantidad Disponible Insuficiente", 'warning');
            return;
        }

        var es = 1;

        ProductoSeleccionado.Cant = parseInt(cant);

        for (var i = 0; i < productos.length; i++) {
            if (productos[i].Producto_Id == ProductoSeleccionado.Producto_Id) {
                es = 0;
                $("#Cant").val('');
                if ((parseInt(productos[i].Cant) + parseInt(cant)) > ProductoSeleccionado.Stock) {
                    AlertaMensaje("Cantidad el Producto", "Cantidad máxima superada", "warning");
                    return;
                }
                productos[i].Cant = parseInt(productos[i].Cant) + parseInt(cant);
                productos[i].Total = (parseFloat(productos[i].Cant) * parseFloat(productos[i].Precio)).toFixed(2);

                break;
            }
        }


        if (es == 1) {
            
            ProductoSeleccionado.Total = parseFloat(ProductoSeleccionado.Cant) * parseFloat(ProductoSeleccionado.Precio);
            productos.push(ProductoSeleccionado);
        }

        productos = Totales(productos);

        ProductoSeleccionado = null;

        tablaFactura.clear().draw();
        tablaFactura.rows.add(productos).draw();
        $("#Cant").val('');
        CloseModal('Cantidad')

    }

    $(document).ready(function () {


        tablaFactura = $('#TbFactura').DataTable({
            ordering: false,
            searching: false,
            lengthChange: false,
            info: false,
            paging: false,
            data: [],
            columnDefs: [

                { "data": "Num", targets: 0 },
                { "data": "Producto_Id", targets: 1, visible: false },
                { "data": "Producto1", targets: 2 },
                { "data": "Cant", targets: 3 },
                { "data": "Precio", targets: 4 },
                { "data": "Total", targets: 5 },
                {
                    "data": null, targets: 6, render: function (data) {
                        return ` <button id="btnEditar" class="btn"><i    class="fas fa-edit"></i></button> <button id="btnEliminar" class="btn"><i class="fas fa-trash-alt"></i></button>  `;
                    }
                },


            ]
        });

        $("#TbFactura tbody").on("click", "button", function () {
            let Origen = $(this).attr("id");
            switch (Origen) {
                case "btnEliminar": {
                    let Datos = tablaFactura.row($(this).parents("tr")).data();

                    swal({
                        title: "Desea Borrar?",
                        text: "Borrar Producto: " + Datos.Producto1,
                        icon: "warning",
                        buttons: true,
                        dangerMode: true,
                    })
                        .then((willDelete) => {
                            if (willDelete) {
                                var datosNuevos = [];
                                for (var i = 0; i < productos.length; i++) {
                                    if (productos[i].Producto_Id != Datos.Producto_Id) {
                                        datosNuevos.push(productos[i]);
                                    }
                                }

                                productos = Totales(datosNuevos);
                                tablaFactura.clear().draw();
                                tablaFactura.rows.add(productos).draw();

                                swal("Producto Eliminado..", {
                                    icon: "success",
                                });
                            }
                        });

                    break;
                }
                case "btnEditar": {
                    let Datos = tablaFactura.row($(this).parents("tr")).data();
                    Cambio = 0;
                    OpenModal('Productos');
                    temp = Datos;
                    break;
                }
            }
        });



        tablaClientes = $('#tbClientes').DataTable({
            "ordering": false,
            "language": {
                "url": "https://cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/Spanish.json"
            },
            "data": [],
            "columns":
                [
                    { "data": "Cliente_Id", visible: false },
                    { "data": "Ced_Ruc_Cliente" },
                    { "data": "Nombre_Cliente" },
                    { "data": "Apellido_Cliente" },
                    { "data": "Telefono_Cliente" },
                    { "data": "Direccion_Cliente" },
                ],
        });

        tablaProductos = $('#tbProductos').DataTable({
            "ordering": false,
            "language": {
                "url": "https://cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/Spanish.json"
            },
            "data": [],
            "columns":
                [
                    { "data": "Producto_Id", visible: false },
                    { "data": "Producto1" },
                    { "data": "Stock" },
                    { "data": "Precio" },
                ],
        });



        $("#tbClientes tbody").on("click", "tr", function () {
            var data = tablaClientes.row(this).data();
            $("#btnProductos").removeAttr('disabled');
            Cli = data;

            $("#Ced").empty();
            $("#NombreCliente").empty();
            $("#Direccion").empty();
            $("#Telefono").empty();

            $("#Ced").append(Cli.Ced_Ruc_Cliente);
            $("#NombreCliente").append(Cli.Nombre_Cliente + ' ' + Cli.Apellido_Cliente);
            $("#Direccion").append(Cli.Direccion_Cliente);
            $("#Telefono").append(Cli.Telefono_Cliente);

            CloseModal('Clientes');
        });

        $("#tbProductos tbody").on("click", "tr", function () {
            var data = tablaProductos.row(this).data();

            ProductoSeleccionado = data;

           

            if (Cambio == 1) {
                OpenModal('Cantidad');
                $("#nombreP").val(data.Producto1);
                $("#Precio").val(data.Precio);
                $("#Cant").focus();
            } else {
                

                for (var i = 0; i < productos.length; i++) {
                    if (productos[i].Producto_Id == temp.Producto_Id) {
                        ProductoSeleccionado.Cant = productos[i].Cant;
                        productos[i] = ProductoSeleccionado;
                        break;
                    }
                }
                
                productos = Totales(productos);
                tablaFactura.clear().draw();

                tablaFactura.rows.add(productos).draw();

                Cambio = 1;
            }



            CloseModal('Productos');
        });

        CargarClientes();
        CargarProductos();

        $("#btnGuardar").attr('disabled', 'disabled');
        $("#btnProductos").attr('disabled', 'disabled');
    });





    function AlertaMensaje(Titulo, Texto, Icono) {
        swal({
            title: Titulo,
            text: Texto,
            icon: Icono,
            dangerMode: true,
        });
    }

    function CargarClientes() {
        $.ajax({
            async: false,
            url: "@Url.Content("~/Home/Clientes")",
            dataType: 'json',
            type: 'POST',
            success: function (data) {
                if (data.Mensaje != null ) {
                    AlertaMensaje("Error", data.Mensaje, "error");
                } else {
                    tablaClientes.clear().draw();
                    tablaClientes.rows.add(data.Info).draw();
                }
            },
            error: function (err) {
                AlertaMensaje("Error", "Error al Cargar Productos", "error");
            }
        });
    }

    function CargarProductos() {
        $.ajax({
            async: false,
            url: "@Url.Content("~/Home/Productos")",
            dataType: 'json',
            type: 'POST',
            success: function (data) {
                if (data.Error != null ) {
                    AlertaMensaje("Error", data.Error, "error");
                } else {
                    tablaProductos.clear().draw();
                    tablaProductos.rows.add(data.Info).draw();
                }
            },
            error: function (err) {
                AlertaMensaje("Error", "Error al Cargar Productos", "error");
            }
        });
    }



    function Totales(listado) {
        var sum = 0;
        var iva = 0;
        var total = 0;


        if (listado.length > 0) {
            $("#btnGuardar").removeAttr('disabled');
        } else {
            $("#btnGuardar").attr('disabled', 'disabled');
        }

        for (var i = 0; i < listado.length; i++) {
            listado[i].Num = (i + 1);

            listado[i].Total = (parseFloat(listado[i].Cant) * parseFloat(listado[i].Precio)).toFixed(2);
            sum += parseFloat(listado[i].Total);
        }

        sum = sum.toFixed(2);

        iva = (sum * 0.12).toFixed(2);
        total = (parseFloat(sum) + parseFloat(iva)).toFixed(2);

        $("#Subtotal").empty();
        $("#Total").empty();
        $("#Iva").empty();

        $("#Subtotal").append('$ ' + sum);
        $("#Total").append('$ ' + total);
        $("#Iva").append('$ ' + iva);

        return listado;

    }

    function GuardarFactura() {

         $.ajax({
            url: "@Url.Content("~/Home/GuardarFactura")",
            dataType: 'json',
            type: 'POST',
             data: {
                 "cliente": Cli,
                 "productos": productos
            },
            success: function (data) {
                console.log(data)
                if (data.Error != null) {
                    AlertaMensaje("Error", data.Error, "error");
                } else {

                    swal("Factura Guardado", "Registro Exitoso", "success").then((willDelete) => {
                        if (willDelete) {
                            window.location.href = "@Url.Action("ListaFacturas", "Home")";
                        }
                    });;
                }
            },
             error: function (err) {
                 AlertaMensaje("Error", "Error la guardar la factura", "error");
            }
        });
    }

</script>
